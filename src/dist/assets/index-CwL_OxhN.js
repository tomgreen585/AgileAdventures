var $=Object.defineProperty;var G=o=>{throw TypeError(o)};var z=(o,e,t)=>e in o?$(o,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):o[e]=t;var O=(o,e,t)=>z(o,typeof e!="symbol"?e+"":e,t),P=(o,e,t)=>e.has(o)||G("Cannot "+t);var a=(o,e,t)=>(P(o,e,"read from private field"),t?t.call(o):e.get(o)),E=(o,e,t)=>e.has(o)?G("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(o):e.set(o,t),u=(o,e,t,s)=>(P(o,e,"write to private field"),s?s.call(o,t):e.set(o,t),t),B=(o,e,t)=>(P(o,e,"access private method"),t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const n of i)if(n.type==="childList")for(const c of n.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&s(c)}).observe(document,{childList:!0,subtree:!0});function t(i){const n={};return i.integrity&&(n.integrity=i.integrity),i.referrerPolicy&&(n.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?n.credentials="include":i.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(i){if(i.ep)return;i.ep=!0;const n=t(i);fetch(i.href,n)}})();const d=Object.freeze({PRELOAD_SCENE:"PRELOAD_SCENE",MAIN_MENU_SCENE:"MAIN_MENU_SCENE",WORLD_SCENE:"WORLD_SCENE"}),f=Object.freeze({MAIN_MENU:"MAIN_MENU",MENU_BUTTON:"MENU_BUTTON",MENU_BORDER:"MENU_BORDER",TITLE:"TITLE"}),L=Object.freeze({CROSS:"CROSS",RELOAD:"RELOAD"}),N=Object.freeze({MAP:"MAP",WALLS:"WALLS",WALL_CSV:"WALL_CSV"}),W=Object.freeze({ANIMATIONS:"ANIMATIONS"}),F=Object.freeze({PLAYER:"PLAYER"}),H=Object.freeze({MAIN_MENU:"MAIN_MENU"}),D="Kenney-Future";function V(o,e){new FontFace(o,`url(${e})`).load().then(s=>{document.fonts.add(s),console.log(`${o} font loaded`)}).catch(s=>{console.error(`Failed to load font: ${o}`,s)})}class J{static getAnimations(e){return e.cache.json.get(W.ANIMATIONS)}}var C,K;const U=class U extends Phaser.Scene{constructor(){super({key:d.PRELOAD_SCENE});E(this,C);console.log(d.PRELOAD_SCENE)}preload(){console.log("preload"),fetch("/api/env").then(t=>t.json()).then(t=>{console.log("Environment variables:",t),this.environment=t.environment,console.log(`Environment: ${this.environment}`)}).catch(t=>console.error("Error fetching environment variables:",t)),this.load.text(N.WALL_CSV,"assets/map/engr-walls.csv"),this.load.image(f.MAIN_MENU,"assets/images/main-menu.png"),this.load.image(f.MENU_BUTTON,"assets/images/menu-button.png"),this.load.image(f.MENU_BORDER,"assets/images/menu-border.png"),this.load.image(N.MAP,"assets/map/engr-map.png"),this.load.image(f.TITLE,"assets/images/menu-title.png"),this.load.image(L.CROSS,"assets/images/icon-cross.png"),this.load.image(L.RELOAD,"assets/images/icon-reload.png"),this.load.image(N.WALLS,"assets/map/engr-map-walls.png"),this.load.spritesheet(F.PLAYER,"assets/images/character.png",{frameHeight:88,frameWidth:64}),this.load.json(W.ANIMATIONS,"assets/data/animations.json"),V(D,"assets/fonts/kenney-future.ttf"),this.load.audio(H.MAIN_MENU,"assets/audio/main-menu-music.ogg")}create(){console.log(`[${U.name}:create] invoke`),B(this,C,K).call(this),console.log(this.environment),this.scene.start(d.MAIN_MENU_SCENE)}};C=new WeakSet,K=function(){J.getAnimations(this).forEach(s=>{const i=s.frames?this.anims.generateFrameNumbers(s.assetKey,{frames:s.frames}):this.anims.generateFrameNumbers(s.assetKey);this.anims.create({key:s.key,frames:i,frameRate:s.frameRate,repeat:s.repeat,delay:s.delay,yoyo:s.yoyo})})};let v=U,T;function X(){return T||(T=io(`${window.location.protocol}//${window.location.hostname}`)),T}const _=X(),q=Object.freeze({menu:{fontFamily:D,color:"#4D4A49",fontSize:"30px"},title:{fontFamily:D,color:"#7994a0",fontSize:"50px"}});class j extends Phaser.Scene{constructor(){super({key:d.MAIN_MENU_SCENE}),console.log(d.MAIN_MENU_SCENE)}create(){console.log(`[${j.name}:create] invoke`),this.add.image(0,0,f.MAIN_MENU).setOrigin(0),this.add.image(this.scale.width/2,100,f.TITLE).setScale(.5),this.createButtonContainer(),this.createServerContainer(),this.loadServerList()}createButtonContainer(){this.buttonContainer=this.add.container(this.scale.width/2,this.scale.height/2),[{y:-50,text:"Create",handler:()=>this.handleStart()},{y:50,text:"Join",handler:()=>this.handleJoinButton()},{y:150,text:"Settings",handler:()=>this.handleStart()}].forEach(({y:t,text:s,handler:i})=>{const n=this.createButton(0,t,s,i);this.buttonContainer.add(n)})}createButton(e,t,s,i){const n=this.add.container(e,t),c=this.add.image(0,0,f.MENU_BUTTON).setOrigin(.5).setScale(1.2).setInteractive(),Y=this.add.text(0,0,s,q.menu).setOrigin(.5);return n.add([c,Y]),c.on("pointerdown",i),n}createServerContainer(){this.serverContainer=this.add.container(this.scale.width/2,this.scale.height/2+100).setVisible(!1);const e=this.add.nineslice(0,0,f.MENU_BORDER,0,400,300,10,10,10,10).setOrigin(.5),t=this.add.image(e.width/2-20,-e.height/2+20,L.CROSS).setOrigin(.5).setInteractive().on("pointerdown",()=>{this.buttonContainer.setVisible(!0),this.serverContainer.setVisible(!1)}),s=this.add.image(-e.width/2+30,-e.height/2+30,L.RELOAD).setOrigin(1).setScale(.5).setInteractive().on("pointerdown",()=>this.loadServerList()),i=this.add.text(this.serverContainer.width/2,-120,"Rooms:").setOrigin(.5);this.serverContainer.add([e,t,s,i])}updateRoomList(e){if(this.serverContainer.list.forEach(t=>{t instanceof Phaser.GameObjects.Container&&t.destroy()}),e.length!==0){const t=e.split(","),s=80;console.log("found a room"),t.forEach((i,n)=>{const c=this.createButton(0,-this.serverContainer.getAt(0).height/2+100+n*s,i,()=>this.handleRoomButtonClick(i));this.serverContainer.add(c)})}}handleRoomButtonClick(e){console.log(`Joining room: ${e}`),_.emit("joinRoom",e),this.scene.start(d.WORLD_SCENE,{roomId:e,socket:_})}handleStart(){console.log("Create room pressed");const e=prompt("Enter a name for the new room:");e&&(_.emit("createRoom",e),this.scene.start(d.WORLD_SCENE,{roomId:e,socket:_}))}handleJoinButton(){this.buttonContainer.setVisible(!1),this.serverContainer.setVisible(!0)}loadServerList(){_.emit("requestRoomNames"),_.on("roomNames",e=>{this.updateRoomList(e)})}}const r=Object.freeze({LEFT:"LEFT",RIGHT:"RIGHT",UP:"UP",DOWN:"DOWN",NONE:"NONE"}),R=48,p=5;class Z{constructor(e){O(this,"_scene");O(this,"_direction");O(this,"_isMoving");O(this,"_phaserGameObject");O(this,"_debugBorder");this._scene=e.scene,this._direction=r.DOWN,this._isMoving=!1,this._phaserGameObject=this._scene.add.sprite(e.position.x,e.position.y,e.assetKey,e.assetFrame||0).setOrigin(0),this._debugBorder=this._scene.add.graphics(),this._debugBorder.lineStyle(4,16711680,1),this._debugBorder.strokeRect(this._phaserGameObject.x,this._phaserGameObject.y,this._phaserGameObject.displayWidth,this._phaserGameObject.displayHeight)}get sprite(){return this._phaserGameObject}update(){var t;if(this._isMoving)return;const e=(t=this._phaserGameObject.anims.currentAnim)==null?void 0:t.frames[1].frame.name;if(this._phaserGameObject.anims.stop(),!!e)switch(this._direction){case r.DOWN:case r.LEFT:case r.RIGHT:case r.UP:this._phaserGameObject.setFrame(e);break;case r.NONE:break}}moveCharacter(e){switch(e){case r.DOWN:this._phaserGameObject.y+=p;break;case r.UP:this._phaserGameObject.y-=p;break;case r.LEFT:this._phaserGameObject.x-=p;break;case r.RIGHT:this._phaserGameObject.x+=p;break}this._debugBorder.clear(),this._debugBorder.lineStyle(4,16711680,1),this._debugBorder.strokeRect(this._phaserGameObject.x,this._phaserGameObject.y,this._phaserGameObject.width,this._phaserGameObject.height)}nextMoveWalkable(e,t){this.tilemapArray=t;let s=this._phaserGameObject.x,i=this._phaserGameObject.y;switch(e){case r.DOWN:i+=p;break;case r.UP:i-=p;break;case r.LEFT:s-=p;break;case r.RIGHT:s+=p;break}const n=Math.floor(s/R),c=Math.floor((i+this._phaserGameObject.height/2)/R);return this.isTileWalkable(n,c)}isTileWalkable(e,t){return this.tilemapArray[t][e]===-1}}class x extends Z{constructor(e){super({...e,assetKey:F.PLAYER,assetFrame:7})}moveCharacter(e){var t;switch(super.moveCharacter(e),e){case r.DOWN:case r.LEFT:case r.RIGHT:case r.UP:(!this._phaserGameObject.anims.isPlaying||((t=this._phaserGameObject.anims.currentAnim)==null?void 0:t.key)!==`PLAYER_${e}`)&&this._phaserGameObject.play(`PLAYER_${e}`);break;case r.NONE:break}}}var y,h,b;class Q{constructor(e){E(this,y);E(this,h);E(this,b);u(this,y,e),u(this,h,a(this,y).input.keyboard.createCursorKeys()),u(this,b,!1)}get isInputLocked(){return a(this,b)}set lockInput(e){u(this,b,e)}wasSpaceKeyPress(){return a(this,h)===void 0?!1:Phaser.Input.Keyboard.JustDown(a(this,h).space)}wasEscKeyPress(){return a(this,h)===void 0?!1:Phaser.Input.Keyboard.JustDown(a(this,h).shift)}getDirectionKeyPressedDown(){if(a(this,h)===void 0)return r.NONE;let e=r.NONE;return a(this,h).left.isDown?e=r.LEFT:a(this,h).right.isDown?e=r.RIGHT:a(this,h).up.isDown?e=r.UP:a(this,h).down.isDown&&(e=r.DOWN),e}}y=new WeakMap,h=new WeakMap,b=new WeakMap;let g,m={},I=[];const ee=Object.freeze({x:18*R,y:20*R});var l,S,A;const k=class k extends Phaser.Scene{constructor(){super({key:d.WORLD_SCENE});E(this,l);E(this,S);E(this,A,"");console.log(d.WORLD_SCENE)}init(t){g=t.socket,t.roomId&&(u(this,A,t.roomId),console.log(`Room ID received: ${a(this,A)}`))}create(){console.log(`[${k.name}:create] invoke`),this.tilemapArray=this.cache.text.get(N.WALL_CSV).trim().split(`
`).map(t=>t.split(",").map(Number)),this.add.image(0,0,N.MAP).setOrigin(0).setScale(1),this.add.image(0,0,N.WALLS).setOrigin(0).setScale(1).setDepth(1),u(this,l,new x({scene:this,position:ee})),this.cameras.main.setBounds(0,0,1e4,1e4),this.cameras.main.startFollow(a(this,l).sprite),u(this,S,new Q(this)),g.on("updatePlayers",this.handleUpdatePlayers.bind(this)),g.on("playerMoved",this.handlePlayerMoved.bind(this)),g.on("disconnect",this.handlePlayerDisconnect.bind(this))}update(){var s,i,n,c;const t=a(this,S).getDirectionKeyPressedDown();if(t!==r.NONE){if(!((i=(s=a(this,l)).nextMoveWalkable)!=null&&i.call(s,t,this.tilemapArray)))return;a(this,l)._isMoving=!0,(c=(n=a(this,l)).moveCharacter)==null||c.call(n,t),this.sendPlayerPosition()}else a(this,l)._isMoving=!1,a(this,l).update()}sendPlayerPosition(){const t={x:a(this,l).sprite.x,y:a(this,l).sprite.y};let s=a(this,S).getDirectionKeyPressedDown();g.emit("playerMoved",{id:g.id,position:t,direction:s,isMoving:a(this,l)._isMoving,roomName:a(this,A)})}handleUpdatePlayers(t){t.forEach(s=>{if(s.id!==g.id)if(m[s.id])s.isMoving?m[s.id].moveCharacter(s.direction):m[s.id].update();else{console.log(`[${s.id}] Player not found.`);let i=new x({scene:this,position:s.position});m[s.id]=i,I.push(i)}}),Object.keys(m).forEach(s=>{t.find(i=>i.id===s)||this.handlePlayerDisconnect(s)})}handlePlayerMoved(t){const{id:s,position:i}=t;s!==g.id&&m[s]&&m[s].setPosition(i.x,i.y)}handlePlayerDisconnect(t){m[t]&&(m[t]._phaserGameObject.destroy(),delete m[t],I=I.filter(s=>s!==m[t]))}};l=new WeakMap,S=new WeakMap,A=new WeakMap;let w=k;const M=new Phaser.Game({type:Phaser.AUTO,scale:{parent:"game-container",width:1024,height:576,mode:Phaser.Scale.FIT,autoCenter:Phaser.Scale.CENTER_BOTH}});M.scene.add(d.PRELOAD_SCENE,v);M.scene.add(d.MAIN_MENU_SCENE,j);M.scene.add(d.WORLD_SCENE,w);M.scene.start(d.PRELOAD_SCENE);
